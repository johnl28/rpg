let LOADER=PIXI.Loader.shared,entityID=1;class Game{width=window.innerWidth;height=window.innerHeight;proto={};running=!1;app=null;player=null;map=null;constructor(){window.onresize=()=>{this.width=this.app.width=window.innerWidth,this.height=this.app.height=window.innerHeight}}GameLoop(){this.player&&this.player.OnTickUpdate(this),this.map&&this.map.OnTickUpdate(this)}StartGame(){this.__initGame(),this.running=!0}__initGame(){this.app=new PIXI.Application({width:this.width,height:this.height}),PIXI.Ticker.shared.maxFPS=40,document.body.appendChild(this.app.view),log("Game init DONE!"),gameInterface.SetLoadingText("Game initialization..."),this.__loadAssets()}__loadAssets(){gameInterface.SetLoadingText("Load assets...");const e=PIXI.Loader.shared;for(var a in e.defaultQueryString=""+Math.random(),e.baseUrl=ASSETS_PATH,e.onComplete.add((()=>{log("Load assets DONE!"),this.__LoadProtoTables()})),ASSETS)e.add(a,ASSETS[a]);e.load()}__LoadProtoTables(){this.__loadProto("monster_proto",(()=>{this.__loadProto("object_proto",(()=>{this.__loadProto("item_proto",(()=>{this.__loadMap()}))}))}))}__loadProto(e,a){gameInterface.SetLoadingText(`Load ${e} table...`),fetch(`assets/${e}.json`,{cache:"no-store"}).then((e=>e.json())).then((t=>{this.proto[e]=t,log(`${e} load DONE!`),a()}))}__loadMap(){gameInterface.SetLoadingText("Load map data..."),this.map=new Map,this.map.Load("empire1",(()=>{log("Map load DONE!"),this.__loadCharacter()})),this.app.stage.addChild(this.map),this.app.ticker.add((()=>this.GameLoop()))}__loadCharacter(){if(gameInterface.SetLoadingText("Load character..."),this.player=new Player(0,0,this.map),!this.player)return void error("Player instance fail to create.");let e=this.map.basePosition.x,a=this.map.basePosition.y,t=localStorage.getItem("player_data");t&&(t=JSON.parse(t),a=t.y,e=t.x,this.player.level=t.level,this.player.name=t.name,this.player.playTime=t.play_time),this.player.Spawn(e,a),log("Character load DONE!"),gameInterface.GameLoaded(),this.timeInterval=setInterval((()=>{this.player.playTime+=1,this.player.lastInteract+60<this.player.playTime&&this.player.SetState("CAST")}),1e3)}OnKeyUp(e){if(this.running&&!this.player.IsState("DIE"))switch(e.code){case"KeyD":case"KeyA":case"KeyW":case"KeyS":this.player.SetIDLE();break;case"Escape":if(gameInterface.mobHud.is(":visible"))return void gameInterface.mobHud.hide();if(gameInterface.mainMenu.is(":visible")&&this.running)return void gameInterface.mainMenu.hide();gameInterface.mainMenu.show()}}OnKeyDown(e){if(this.running)switch(e.code){case"KeyR":this.player.Respawn();break;case"KeyD":case"KeyA":this.player.MoveX(e.code);break;case"KeyW":case"KeyS":this.player.MoveY(e.code);break;case"Space":case"KeyF":this.player.AttackInput(e.code)}}}
