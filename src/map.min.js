class Map extends PIXI.TilingSprite{entityVID=1e3;entities={};objects=[];basePosition={};size={};constructor(){super(LOADER.resources.grass1.texture,500,500),this.sortableChildren=!0}Reset(){this.entityVID=1e3,this.basePosition={},this.size={},this.entities={}}OnTickUpdate(t){this.__updateBackgroundScroll(t.player);for(let e in this.entities)this.entities[e].OnTickUpdate(t)}__updateBackgroundScroll(t){if(!t)return;let e=t.container.getGlobalPosition(),i=t.GetSpeed(),s=gameInstance.width;e.x>s&&(i=300),e.x<0?this.x=0:(e.x>s/2-20&&this.x>s-this.width&&(this.x-=i),e.x<s/2+20&&this.x<0&&(this.x+=i),e.y>gameInstance.height-200&&this.y>gameInstance.height-this.height?this.y-=i:e.y<200&&this.y<0&&(this.y+=i))}SpawnMonster(t,e,i){let s=gameInstance.proto.monster_proto[t],n=this.entityVID++,o=new Monster(t,n,this);o.SetAttributes(s.attributes),o.name=s.name,o.level=s.level,o.resourceName=s.sprite_sheet,o.stateAnimations=s.animations,o.Spawn(e,i),s.scale&&o.SetScale(s.scale),o.SetZ(i+o.GetHeight()),Math.floor(2*Math.random())&&o.SetDirection(-1),this.entities[n]=o}LoadObjects(t){for(let e in t){let i=t[e],s=new Entity(5e3+e,this);s.LoadSprite(i.texture),i.rotation&&s.SetRotation(i.rotation),i.scale&&s.SetScale(i.scale),i.z?s.SetZ(i.z):s.SetZ(i.y+s.GetHeight()),i.collision&&s.LoadCollisionData(i.collision),s.Show(i.x,i.y),this.objects.push(s)}}LoadEntities(t){for(let e in t){let i=t[e];this.SpawnMonster(i.id,i.x,i.y)}}Load(t,e){fetch(`assets/map/${t}.json?td=${Math.random()}`).then((t=>t.json())).then((t=>{this.width=t.size.width,this.height=t.size.height,this.basePosition=t.base_position,this.texture=LOADER.resources[t.texture].texture,this.LoadObjects(t.objects),this.LoadEntities(t.entities),e()}))}}
